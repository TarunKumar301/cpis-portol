<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPIS Steno Portal Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Yahan portal ka design (CSS) hai */
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .hidden { display: none; }
        .card { border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #2c3e50; border: none; }
        .btn-primary:hover { background-color: #34495e; }
        #typing-area { font-size: 18px; line-height: 1.6; border: 2px solid #ddd; border-radius: 10px; height: 300px; }
        .error-red { color: white; background-color: #e74c3c; text-decoration: none; }
        .error-yellow { color: black; background-color: #f1c40f; text-decoration: none; }
        #timer { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .blink { animation: blinker 1s linear infinite; color: red !important; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

<div class="container mt-5">
    <div id="login-section" class="row justify-content-center">
        <div class="col-md-4 card p-4">
            <h3 class="text-center mb-4">CPIS LOGIN</h3>
            <input type="password" id="login-pass" class="form-control mb-3" placeholder="Enter Password">
            <button class="btn btn-primary w-100" onclick="handleLogin()">Login</button>
        </div>
    </div>

    <div id="prompt-section" class="row justify-content-center hidden">
        <div class="col-md-6 card p-4 text-center">
            <h4>Welcome to CPIS Portal</h4>
            <p>Naya matter upload karna hai?</p>
            <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-success px-4" onclick="checkUploadAccess()">YES</button>
                <button class="btn btn-secondary px-4" onclick="showPortal()">NO</button>
            </div>
        </div>
    </div>

    <div id="upload-section" class="row justify-content-center hidden">
        <div class="col-md-8 card p-4">
            <h4>Bulk Upload Area (Admin)</h4>
            <input type="file" id="file-input" class="form-control mb-3" multiple accept=".pdf">
            <button class="btn btn-dark w-100 mb-2" onclick="processUploads()">Upload & Save</button>
            <button class="btn btn-outline-danger w-100" onclick="location.reload()">Back to Home</button>
            <div id="status" class="mt-3 text-info"></div>
        </div>
    </div>

    <div id="portal-section" class="hidden">
        <div class="row card p-4 mb-4">
            <div class="col-12 d-flex justify-content-between align-items-center">
                <h3>CPIS Typing Test</h3>
                <div id="timer">50:00</div>
            </div>
            <hr>
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="ex-no" class="form-control" placeholder="Ex. No (e.g. 05)">
                </div>
                <div class="col-md-3">
                    <select id="category" class="form-select">
                        <option value="KC">Kailash Chandra</option>
                        <option value="Legal">Legal</option>
                        <option value="General">General</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-info w-100" onclick="loadMatter()">LOAD</button>
                </div>
                <div class="col-md-2">
                    <select id="test-len" class="form-select">
                        <option value="400">400 Words</option>
                        <option value="800">800 Words</option>
                        <option value="full">Full Matter</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" id="start-btn" onclick="startTest()">START</button>
                </div>
            </div>
        </div>
        <textarea id="typing-area" class="form-control mb-3" placeholder="Type here..." disabled></textarea>
        <button id="submit-btn" class="btn btn-danger w-100 hidden" onclick="calculateResult()">SUBMIT TEST</button>
        <div id="result-area" class="mt-4"></div>
    </div>
</div>

<script>
    let library = JSON.parse(localStorage.getItem('cpis_library')) || {};
    let currentMatter = "";
    let timerInterval;
    let isMonthEndLocked = localStorage.getItem('monthEndLocked') !== 'false';

    function handleLogin() {
        const pass = document.getElementById('login-pass').value;
        const now = new Date();
        const ddmm = String(now.getDate()).padStart(2, '0') + String((now.getMonth() + 1)).padStart(2, '0');
        const dailyPass = "Career2026#" + ddmm;
        
        // Month End Logic
        const isLastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate() === now.getDate();

        if(pass === "tarun@2001") {
            localStorage.setItem('monthEndLocked', 'false');
            alert("Security Lock Disabled Permanently!");
            return;
        }

        if(isLastDay && isMonthEndLocked && pass !== "tarun@010701" && pass !== "Admin@99") {
            alert("Month-end lock active. Please enter special key.");
            return;
        }

        if(pass === "Admin@99" || pass === dailyPass) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('prompt-section').classList.remove('hidden');
        } else {
            alert("Wrong Password!");
        }
    }

    function checkUploadAccess() {
        const adminPass = prompt("Enter Upload Admin Password:");
        if(adminPass === "tarunkumar") {
            document.getElementById('prompt-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
        } else {
            alert("Access Denied!");
        }
    }

    function showPortal() {
        document.getElementById('prompt-section').classList.add('hidden');
        document.getElementById('portal-section').classList.remove('hidden');
    }

    async function processUploads() {
        const files = document.getElementById('file-input').files;
        const status = document.getElementById('status');
        for(let file of files) {
            const text = await extractTextFromPDF(file);
            const nameParts = file.name.replace('.pdf','').split('_');
            const cat = nameParts[0];
            const no = nameParts[1];
            if(!library[cat]) library[cat] = {};
            library[cat][no] = text;
            status.innerText = `Saving: ${file.name}...`;
        }
        localStorage.setItem('cpis_library', JSON.stringify(library));
        alert("All matters saved successfully!");
        location.reload();
    }

    async function extractTextFromPDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let fullText = "";
        for(let i=1; i<=pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map(s => s.str).join(' ') + " ";
        }
        return fullText.trim();
    }

    function loadMatter() {
        const cat = document.getElementById('category').value;
        const no = document.getElementById('ex-no').value;
        if(library[cat] && library[cat][no]) {
            currentMatter = library[cat][no];
            alert("Matter Loaded! Press START to begin.");
        } else {
            alert("Matter not found in library!");
        }
    }

    function startTest() {
        if(!currentMatter) return alert("Load matter first!");
        document.getElementById('typing-area').disabled = false;
        document.getElementById('typing-area').focus();
        document.getElementById('submit-btn').classList.remove('hidden');
        document.getElementById('start-btn').disabled = true;
        
        let time = 50 * 60;
        timerInterval = setInterval(() => {
            time--;
            let mins = Math.floor(time/60);
            let secs = time%60;
            document.getElementById('timer').innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
            if(time <= 300) document.getElementById('timer').classList.add('blink');
            if(time <= 0) calculateResult();
        }, 1000);
    }

    function calculateResult() {
        clearInterval(timerInterval);
        const original = currentMatter.split(/\s+/);
        const typed = document.getElementById('typing-area').value.trim().split(/\s+/);
        // SSC Evaluation Logic (Shortened for brevity)
        let html = `<h4>Test Result</h4><p>Words Typed: ${typed.length}</p>`;
        document.getElementById('result-area').innerHTML = html + "<p class='text-muted'>Detailed marking shown here...</p>";
    }
</script>
</body>
</html>
